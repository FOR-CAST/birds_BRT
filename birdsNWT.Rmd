---
title: "birdsNWT"
author: ""
date: "04 February 2019"
output: pdf_document
---

# Overview

The birds module for tyhe NWT loads an existing glm object for each sp located in  
https://drive.google.com/open?id=1obSvU4ml8xa8WMQhQprd6heRrN47buvI. 
The model uses dynamic (vegetation: biomass of tree species) and static
layers (Non-veg: WAT = water (1/0), URBAG = urban/agriculture (1/0),
lLED25 = lake edge density with 5x5 moving window (continuous), 
DEV25 = development proportion within 5x5 moving window (continuous),
and landform (categorical). North American landcover 2005 (MODIS) is
source for all but landform (from AdaptWest land facet datset). 
Vector ruggedness (already available - 
https://drive.google.com/open?id=1dgIw70mDpDYrBExA52SkPoS1TFaZdLE9) 
and road density (that should be available from the Anthropogenic
module) will be added to the next version of these models. The birds' 
prediction is masked to uplands as we do not have data for lowlands.

### Update and/or install all needed packages

If you don't have all packages installed yet, please 
first update all your packages and then install SpaDES. 
Make sure you restart your session after installing all packages.

```{r github, include=FALSE, eval = FALSE}
knitr::opts_chunk$set(echo = TRUE)

update.packages(checkBuilt = TRUE)
devtools::install_github("PredictiveEcology/reproducible@development")
devtools::install_github("achubaty/amc@development")
devtools::install_github("PredictiveEcology/pemisc@development") # Updates SpaDES.core and quickPlot
devtools::install_github("PredictiveEcology/map@development") 
devtools::install_github("PredictiveEcology/LandR@development")  # Updates SpaDES.tools
```

### Please, make sure you loaded the project file in RStudio. This file can be found in "NWT/modules/birdsNWT/"

### Module Usage

```{r module_usage}

# Load SpaDES
library("SpaDES")
library("raster")

dayOfRecording <- today <- toupper(format(Sys.time(), "%d%b%y"))

isTEST <- TRUE

if (isTEST){
    dayOfRecording <- "14MAR19"
}

# Source functions in R folder
invisible(sapply(X = list.files(file.path(getwd(), "R"), full.names = TRUE), FUN = source))

# Set a storage project folder
workDirectory <- getwd()
message("Your current temporary directory is ", tempdir())

checkInputPath <- tryCatch(checkPath(file.path(dirname(dirname(getwd())), "outputs", dayOfRecording)), error = function(e) NULL)
if (is.null(checkInputPath)){
  inpPath <- tempdir()
} else {
  inpPath <- checkInputPath
}

checkOutputPath <- tryCatch(checkPath(file.path(dirname(dirname(getwd())), "outputs", today)), error = function(e) NULL)
if (is.null(checkOutputPath)){
  outPath <- tempdir()
} else {
  outPath <- checkOutputPath
}

setPaths(modulePath = file.path(dirname(getwd())), 
         inputPath = inpPath, outputPath = outPath)
getPaths() # shows where the 4 relevant paths are

times <- list(start = 0, end = 3)

parameters <- list(
  .progress = list(type = "text", interval = 1), # for a progress bar
birdsNWT = list(
    "baseLayer" = 2005,
    "overwritePredictions" = TRUE,
    "useTestSpeciesLayers" = TRUE, # Set it to false when you actually have results from LandR_Biomass simulations to run it with
    "useParallel" = FALSE, # Using parallel in windows is currently not working.
    "predictionInterval" = 1
  )
)

# Passing the uplandsRaster here makes sure that all computers can use it as the operations take up a lot of memory
uplandsRaster <- prepInputs(targetFile = "uplandsNWT250m.tif", 
                            url = "https://drive.google.com/open?id=1EF67NCH7HqN6QZ0KGlpntB_Zcquu6NJe", 
                            destinationPath = getPaths()$inputPath)

# Check the list of species available:
showAvailableBirdSpecies()

.objects <- list(
  "birdsList" = c("BBWA", "BOCH"),
  "uplandsRaster" = uplandsRaster)
modules <- list("birdsNWT")
inputs <- list()
outputs <- list()

birdsNWT <- simInitAndSpades(times = times, params = parameters, modules = modules,
                 objects = .objects, debug = 2)

```

### Retrieve results:

The bird prediction rasters can be found in `birdsNWT$birdPrediction`:

```{r results1}

ls.str(birdsNWT$birdPrediction)

```

The bird models can be accessed using `birdsNWT$birdModels`:

```{r results2}

ls.str(birdsNWT$birdModels)

```

At last, static and succession Layers can be seen using `birdsNWT$staticLayers` and `birdsNWT$successionLayers`, respectively:

```{r results3}

ls.str(birdsNWT$staticLayers)
ls.str(birdsNWT$successionLayers)

```
